<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <head>
    <title>ESB+SB / Test Graphs</title>
    <style>
      body {
        font: 10px sans-serif;
        color: black;
      }

      .graph_container {
        position: relative;
        margin: 100px auto;
        width: 960px;
      }
      
      .axis path,
      .axis line {
        fill: none;
        stroke: #CCC;
        shape-rendering: crispEdges;
      }
      .axis-text {
        color: red;
      }

      .area_value1 {
        fill: url(#first-gradient);
        stroke-width: 0px;
        opacity: 0.7;
      }

      .area_value2 {
        fill: url(#second-gradient);
        stroke-width: 0px;
        opacity: 0.7;
      }

      h1 {
        text-transform: uppercase;
        font-size: 3em;
        line-height: 0.3em;
      }
      p {
        font-size: 12px;
        font-weight: bold;
      }
      span.chiefs {
        color: #C60C30;
      }
      span.broncos {
        color: #FF6319;
      }

    </style>
  </head>
  <body>

    <div id="graph_container_1" class="graph_container"><h1># Tweets / hour</h1><p><span class="broncos">Broncos</span> vs <span class="chiefs">Chiefs</span><br/> Sunday November 17th</p></div>
    <div id="graph_container_2" class="graph_container"><h1>Positive Mentions / hour</h1><p><span class="broncos">Broncos</span> vs <span class="chiefs">Chiefs</span><br/> Sunday November 17th</p></div>
    <div id="graph_container_3" class="graph_container"><h1>Confidence</h1><p><span class="broncos">Broncos</span> vs <span class="chiefs">Chiefs</span><br/> Sunday November 17th</p></div>

  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" charset="utf-8">
    
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - General Vars - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    // Vars for graph size.
    var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
    // Our Date parsing format.
    // TODO: right now it ignores 15-minutes and minutes units. Need to handle these eventually...
    var parseDate = d3.time.format("%Y,%m,%d,%H").parse;      // "%-" means it ignores padding, removing the need for zero-padding perhaps?
    // Setup X and Y scales.
    var x = d3.time.scale()
        .range([0, width]);
    var y = d3.scale.linear()
        .range([height, 0]);
    // Setup X and Y axis, using the scales.
    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");
    // Create SVG element for the graphs.
    var graph1 = d3.select("#graph_container_1").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("top", 100)
      .append("g")                                // "g" is a SVG group element for applying properties to many objects at once.
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var graph2 = d3.select("#graph_container_2").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("top", 100)
      .append("g")                                // "g" is a SVG group element for applying properties to many objects at once.
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var graph3 = d3.select("#graph_container_3").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("top", 100)
      .append("g")                                // "g" is a SVG group element for applying properties to many objects at once.
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    // Create our new data array for storing properly formatted data for D3.
    var data;           

    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Data Setup - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    // Use the JSON data : this is real data from our API engine, although it is still in development.
    
    // Graph 1 : Tweets
    // d3.json("data-nov7chiefsbroncos-tweets-timehour-num24.json", function(error, json_data) {                            // RECORDED DATA : use this recorded Tweet data instead, from Chiefs VS Broncos on November 17.
    d3.json("http://97.107.131.209:4577/game/tweets?time=hour&num=24", function(error, json_data) {                         // LIVE DATA
      console.log("- - - - - - - - - - - - - - - - - - ORIGINAL DATA : ")
      console.log(json_data);
      format_raw_data(json_data);
      console.log("- - - - - - - - - - - - - - - - - - D3-FORMATTED DATA : ")
      console.log(data);
      create_graph(graph1, "value1", "value2");
    });
    
    // Graph 2 : Positivity
    // d3.json("data-nov7chiefsbroncos-positivity-timehour-num24.json", function(error, json_data) {                            // RECORDED DATA : use this recorded Positivity data instead, from Chiefs VS Broncos on November 17.
    d3.json("http://97.107.131.209:4577/game/pos?time=hour&num=24", function(error, json_data) {                                // LIVE DATA
      console.log("- - - - - - - - - - - - - - - - - - ORIGINAL DATA : ")
      console.log(json_data);
      format_raw_data(json_data);
      console.log("- - - - - - - - - - - - - - - - - - D3-FORMATTED DATA : ")
      console.log(data);
      create_graph(graph2, "value1", "value2");
    });

    // Graph 3 : Confidence
    // d3.json("data-nov7chiefsbroncos-confidence-timehour-num24.json", function(error, json_data) {                            // RECORDED DATA : use this recorded Confidence data instead, from Chiefs VS Broncos on November 17.
    d3.json("http://97.107.131.209:4577/game/confidence?time=hour&num=24", function(error, json_data) {                         // LIVE DATA
      console.log("- - - - - - - - - - - - - - - - - - ORIGINAL DATA : ")
      console.log(json_data);
      format_raw_data(json_data);
      console.log("- - - - - - - - - - - - - - - - - - D3-FORMATTED DATA : ")
      console.log(data);
      create_graph(graph3, "value2", "value1");
    });

    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Functions - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    // Preprocess the raw data in order to have rows that contain: time, AFC value, NFC value.
    function format_raw_data(raw_data) {
      data = [];      // clear data array

      // first, check if AFC and NFC have same length
      if (raw_data.afc.length === raw_data.nfc.length) {
        console.log("m- AFC and NFC arrays are same length. Continue to preprocessing the D3-ready data array.");

        // rip out data from the AFC object to populate our new data array (since the AFC and NFC objects have the same structure, we can use either one for building our new array).
        raw_data.afc.map(function (cur_row, index) {
          // console.log(cur_row);
          // console.log(cur_row.time[4]);
          cur_row.time.splice(4);                                       // remove the last 2 units for now : the 15-minute and single minute units.
          var new_row = {};                                             // use an object/associative array to store the 3 values of a new row
          new_row["time"] = cur_row.time;                               // store the time
          new_row["value1"] = cur_row.value;                            // store the AFC value as "value1"
          new_row["value2"] = raw_data.nfc[index].value;                // store the related NFC value (at the same current index position) as "value2"
          data.push( new_row );                                         // push the 3 values as a single row, to the new D3 data array
          // console.log(data);
        });

      } else {
        console.log("m- PROBLEM- Original AFC and NFC arrays not same length.")
      }
    }

    // create the graphs/charts
    function create_graph(cur_graph, front_dataset, back_dataset) {

      // Setup each row of data by formatting the Date for X, and by converting to a number for Y.
      // data = data.rows;                           // Descend one level to be where the rows are.
      data.forEach(function(d) {
        console.log("time = "+ String(d.time));
        d.time = parseDate(String(d.time));         // "time" is X value.
        d.value1 = +d.value1;                       // "value" is Y value. Converts the value to a number (default is string).
        d.value2 = +d.value2;
        // console.log("time = "+ String(d.time));
        // console.log("value1 = "+ d.value1);
        // console.log("value2 = "+ d.value2);
      });

      // set the X and Y domains
      x.domain(d3.extent(data, function(d) { return d.time; }));
      y.domain([
        d3.min(data, function(d) { return Math.min(d.value1, d.value2); }),
        d3.max(data, function(d) { return Math.max(d.value1, d.value2); })
      ]);

      // define fill gradient for Team of value1
      cur_graph.append("linearGradient")
        .attr("id", "first-gradient")
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", 0).attr("y1", y(0))
        .attr("x2", 0).attr("y2", y( d3.max(data, function(d) { return d.value1; }) ))
      .selectAll("stop")
        .data([
          {offset: "0%", color: "white"},
          {offset: "50%", color: "#FF6319"}
        ])
      .enter().append("stop")
        .attr("offset", function(d) { return d.offset; })
        .attr("stop-color", function(d) { return d.color; });

      // define fill gradient for Team of value2
      cur_graph.append("linearGradient")
        .attr("id", "second-gradient")
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", 0).attr("y1", y(0))
        .attr("x2", 0).attr("y2", y( d3.max(data, function(d) { return d.value2; }) ))
      .selectAll("stop")
        .data([
          {offset: "0%", color: "white"},
          {offset: "50%", color: "#C60C30"}
        ])
      .enter().append("stop")
        .attr("offset", function(d) { return d.offset; })
        .attr("stop-color", function(d) { return d.color; });

      // ----------------------------- DATASET IN FRONT -----------------------------
      
      var area = d3.svg.area()
        .x(function(d) { return x(d.time); })
        .y0(height)
        .y1(function(d,i) {
          return y(d[front_dataset]);
      })
      .interpolate("linear");

      // Draw the data as area chart.
      cur_graph.append("path")
          .datum(data)
          .attr("class", "area_" + front_dataset)
          .attr("d", area);

      // ----------------------------- DATASET IN BACK -----------------------------
      
      var area = d3.svg.area()
        .x(function(d) { return x(d.time); })
        .y0(height)
        .y1(function(d,i) {
          return y(d[back_dataset]);
      })
      .interpolate("linear");

      // Draw the data as area chart.
      cur_graph.append("path")
          .datum(data)
          .attr("class", "area_" + back_dataset)
          .attr("d", area);

      // ----------------------------------------------------------

      // Draw the X-axis of the graph.
      cur_graph.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

      // Draw the Y-axis of the graph.
      cur_graph.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .attr("class", "axis-text")
          .text("value");

    }


        
  </script>
  
  </body>
</html>